name: Deploy .NET API to EC2

on:
  push:
    branches: [ main ] # This triggers the script every time you push to 'main'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Build and Publish
      run: dotnet publish -c Release -o ./publish

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1 

    - name: Upload to S3
      run: aws s3 sync ./publish s3://sameer-api-transfer-2026 --delete

    - name: Deploy via SSH to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: 13.216.127.105
        username: ec2-user
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # 1. Pull the new files from S3 into the publish-out folder
          aws s3 sync s3://sameer-api-transfer-2026 /home/ec2-user/AwsApi/publish-out --delete
          # 2. Restart the API service to pick up changes
          sudo systemctl restart dotnet-api